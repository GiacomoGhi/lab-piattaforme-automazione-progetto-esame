# Aquarium Monitor - WoT Demo (2026-02-08)

## Scope
Demo application that simulates an aquarium using Web of Things (WoT). It exposes three Things over HTTP, proxies a Modbus TCP pump, and provides a web UI for monitoring and control.

## Runtime Services
- Static web server: http://localhost:3000 (serves index.html and www/)
- WoT HTTP server: http://localhost:8080 (Things endpoints)
- Modbus TCP mock server: 127.0.0.1:502 (simulated pump registers)

## Main Components

### 1) Water Digital Twin (HTTP Thing)
- Source of truth for water state.
- Properties: pH, temperature, oxygenLevel (read/write).
- Degradation simulation runs continuously. It updates all parameters every second and rotates the accelerated parameter per cycle.
- Applies water corrections based on current pump speed read from the FilterPump proxy.
- Exposed at: http://localhost:8080/water

### 2) Water Quality Sensor (HTTP Thing)
- Polls the Water Digital Twin at an interval (demo default: 3000 ms).
- Properties: pH, temperature, oxygenLevel, pHStatus, temperatureStatus, oxygenLevelStatus, allParameters, mode, samplingIntervalMs, config.
- Events: pHStatusChanged, temperatureStatusChanged, oxygenLevelStatusChanged, configChanged.
- Reads configuration from config.json and persists updates back to config.json.
- Exposed at: http://localhost:8080/waterqualitysensor

### 3) Filter Pump (HTTP Thing, Modbus Proxy)
- HTTP proxy that reads/writes pump state through Modbus.
- Properties: pumpSpeed, filterStatus, filterHealth, lastCleaningTime.
- Actions: setPumpSpeed, cleaningCycle.
- Exposed at: http://localhost:8080/filterpump

### 4) Modbus Filter Pump Mock Server (Modbus TCP)
- Uses modbus-serial ServerTCP with an in-memory register map.
- Registers:
	- 0: pumpSpeed (0-100)
	- 1: filterStatus (0=idle, 1=running, 2=cleaning, 3=error)
	- 2: filterHealth (0-100)
	- 3: cleaningCommand (write 1 triggers cleaning)
- Degrades filter health based on pump speed.

## Orchestration Logic (app.ts)
- Orchestrator consumes the HTTP Things and listens for status change events.
- Pump speed is computed from sensor statuses:
	- warning: +15% each
	- alert: +30% each
	- capped to 100%
- When pump speed goes to 0, the Water Digital Twin starts degradation.
- When pump speed > 0, degradation stops.
- Daily cleaning cycle is triggered if filterHealth < 50.

## UI (index.html + www/main.js)
- Polls the Things via HTTP every 3000 ms.
- Displays current parameters, statuses, pump state, and filter health.
- Allows manual pump speed control and cleaning cycle.
- Supports configuration editing (optimal ranges and mode) through the sensor config property.

## Modbus TD Details
- Modbus Thing Description uses application/octet-stream with 2-byte big-endian registers.
- Modbus action forms include invokeaction for WoT action selection.

## Configuration
- config.json stores mode and parameter ranges (configurable and optimal).
- WaterQualitySensor reads config at startup and persists updates.
- Mode affects sampling interval:
	- demo: 3000 ms
	- production: 1800000 ms

## Scripts
- Build: npm run build
- Start app: npm start
- Start Modbus mock: npm run mock
- Build + mock: npm run mock:build

## Typical Run Sequence
1) npm run build
2) npm run mock
3) npm start
4) Open http://localhost:3000

## Ports and Endpoints
- UI: http://localhost:3000
- Water: http://localhost:8080/water
- Water Quality Sensor: http://localhost:8080/waterqualitysensor
- Filter Pump: http://localhost:8080/filterpump
- Modbus TCP: 127.0.0.1:502
